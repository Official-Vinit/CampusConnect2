<% layout('layouts/boilerplate') %>
<h2 class="text-center mt-4">Welcome, <%= user.name %> üëã</h2>

<!-- Display Followers Count -->
<div class="text-center mt-2">
  <p class="text-muted">
    <strong>Followers:</strong> <span class="badge bg-primary"><%= user.followers || 0 %></span>
  </p>
</div>

<div class="container mt-3">
  <div class="d-flex flex-wrap justify-content-center gap-3">
    <form action="/posts/<%= user._id %>/new" method="get">
      <button class="btn btn-dark">Create a Post</button>
    </form>
    <form action="/posts/<%= user._id %>/mypost" method="get">
      <button class="btn btn-dark">My Posts</button>
    </form>
    <form action="/users/<%= user._id %>/favourites" method="get">
      <button class="btn btn-dark">My Favourite Posts</button>
    </form>
    <form action="/logout" method="get">
      <button class="btn btn-dark">Log Out</button>
    </form>
    <form action="/users/<%= user._id %>?_method=DELETE" method="POST">
      <button type="submit" class="btn btn-danger" onclick="return confirm('Are you sure you want to delete your account?')">
        Delete Account
      </button>
    </form>
  </div>
</div>

<div class="container mt-5">
  <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    <% for (let post of posts) { %>
      <div class="col">
        <div class="card h-100 shadow-sm">
          <img src="<%= post.image %>" class="card-img-top" alt="Post Image" style="height: 180px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title"><%= post.caption %></h5>

            <!-- Display Post Author -->
            <p class="card-text text-muted">
              <strong>Posted by:</strong> <%= post.author || 'Anonymous' %>
            </p>

            <!-- Follow Button -->
            <form action="/users/<%= user._id %>/follow/<%= post.authorId %>" method="POST" style="display: inline;">
              <button class="btn btn-primary btn-sm">Follow</button>
            </form>

            <!-- Add to Favourites Button -->
            <form action="/users/<%= user._id %>/favourites/<%= post._id %>" method="POST" style="display: inline;">
              <button class="btn btn-warning btn-sm">Add to Favourites</button>
            </form>

            <p class="card-text">
              <form action="/posts/<%= post._id %>/<%= user._id %>/upvote" method="POST" style="display: inline;">
                <button class="btn btn-success btn-sm" title="Upvote">üëç <%= post.upvotes %></button>
              </form>

              <form action="/posts/<%= post._id %>/<%= user._id %>/downvote" method="POST" style="display: inline;">
                <button class="btn btn-danger btn-sm" title="Downvote">üëé <%= post.downvotes %></button>
              </form>
            </p>

            <p class="card-text"><small class="text-muted">üïí <%= post.createdAt.toDateString() %></small></p>

            <% if (post.comments && post.comments.length > 0) { %>
              <h6 class="mt-3">üó®Ô∏è Comments:</h6>
              <ul class="list-group">
                <% for (let comment of post.comments) { %>
                  <li class="list-group-item" id="comment-<%= comment._id %>">
                    <strong><%= comment.author || 'Anonymous' %>:</strong>
                    <span id="comment-text-<%= comment._id %>"><%= comment.text %></span><br>
                    <small class="text-muted"><%= comment.createdAt.toDateString() %></small>

                    <!-- Display Reactions -->
                    <div class="mt-2">
                      <% if (comment.reactions && comment.reactions.length > 0) { %>
                        <div class="d-flex flex-wrap align-items-center">
                          <% const reactionCounts = comment.reactions[0]; %>
                          <% if (reactionCounts.love > 0) { %>
                            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/react/<%=user._id%>" method="POST" style="display: inline;">
                              <input type="hidden" name="userId" value="<%= user._id %>">
                              <input type="hidden" name="emoji" value="love">
                              <button type="submit" class="badge bg-light text-dark me-2" style="font-size: 1rem; border: none; cursor: pointer;">
                                ‚ù§Ô∏è <small>(<%= reactionCounts.love %>)</small>
                              </button>
                            </form>
                          <% } %>
                          <% if (reactionCounts.laugh > 0) { %>
                            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/react/<%=user._id%>" method="POST" style="display: inline;">
                              <input type="hidden" name="userId" value="<%= user._id %>">
                              <input type="hidden" name="emoji" value="laugh">
                              <button type="submit" class="badge bg-light text-dark me-2" style="font-size: 1rem; border: none; cursor: pointer;">
                                üòÇ <small>(<%= reactionCounts.laugh %>)</small>
                              </button>
                            </form>
                          <% } %>
                          <% if (reactionCounts.wow > 0) { %>
                            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/react" method="POST" style="display: inline;">
                              <input type="hidden" name="userId" value="<%= user._id %>">
                              <input type="hidden" name="emoji" value="wow">
                              <button type="submit" class="badge bg-light text-dark me-2" style="font-size: 1rem; border: none; cursor: pointer;">
                                üòÆ <small>(<%= reactionCounts.wow %>)</small>
                              </button>
                            </form>
                          <% } %>
                          <% if (reactionCounts.like > 0) { %>
                            <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/react" method="POST" style="display: inline;">
                              <input type="hidden" name="userId" value="<%= user._id %>">
                              <input type="hidden" name="emoji" value="like">
                              <button type="submit" class="badge bg-light text-dark me-2" style="font-size: 1rem; border: none; cursor: pointer;">
                                üëç <small>(<%= reactionCounts.like %>)</small>
                              </button>
                            </form>
                          <% } %>
                        </div>
                      <% } else { %>
                        <p class="text-muted">No reactions yet.</p>
                      <% } %>
                    </div>

                    <!-- Reply to Comment Button -->
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="document.getElementById('replyForm-<%= comment._id %>').classList.toggle('d-none')">
                      ‚Ü©Ô∏è Reply
                    </button>

                    <!-- Reply Form (Hidden by Default) -->
                    <form action="/posts/<%= post._id %>/comments/<%= comment._id %>/reply/<%=user._id%>" method="POST" id="replyForm-<%= comment._id %>" class="d-none mt-2">
                      <div class="form-group">
                        <textarea name="text" class="form-control" rows="2" placeholder="Write your reply here..." required></textarea>
                      </div>
                      <button type="submit" class="btn btn-sm btn-success mt-2">Post Reply</button>
                    </form>

                    <!-- Display Replies -->
                    <% if (comment.replies && comment.replies.length > 0) { %>
                      <ul class="list-group mt-3">
                        <% for (let reply of comment.replies) { %>
                          <li class="list-group-item">
                            <strong><%= reply.author || 'Anonymous' %>:</strong>
                            <span><%= reply.text %></span><br>
                            <small class="text-muted"><%= reply.createdAt.toDateString() %></small>
                          </li>
                        <% } %>
                      </ul>
                    <% } %>

                    <% if (comment.author === user.name) { %>
                      <!-- Edit & Delete Buttons -->
                      <div class="mt-2">
                        <button class="btn btn-warning btn-sm" onclick="toggleEditForm('<%= comment._id %>')">Edit</button>

                        <form action="/posts/<%= post._id %>/<%=user._id%>/comment/<%= comment._id %>?_method=DELETE" method="POST" style="display: inline;">
                          <button class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this comment?')">Delete</button>
                        </form>
                      </div>

                      <!-- Edit Comment Form (Hidden by default) -->
                      <form action="/posts/<%= post._id %>/<%=user._id%>/comment/<%= comment._id %>?_method=PUT" method="POST" class="mt-2 d-none" id="edit-form-<%= comment._id %>">
                        <div class="form-group">
                          <textarea name="text" class="form-control" rows="2" required><%= comment.text %></textarea>
                        </div>
                        <button type="submit" class="btn btn-success btn-sm mt-1">Update</button>
                        <button type="button" class="btn btn-secondary btn-sm mt-1" onclick="toggleEditForm('<%= comment._id %>')">Cancel</button>
                      </form>
                    <% } %>
                  </li>
                <% } %>
              </ul>
            <% } else { %>
              <p class="text-muted mt-3">No comments yet.</p>
            <% } %>

            <!-- Add Comment Section -->
            <button class="btn btn-outline-primary btn-sm mt-3" onclick="document.getElementById('commentForm-<%= post._id %>').classList.toggle('d-none')">
              üí¨ Add Comment
            </button>

            <form action="/posts/<%= post._id %>/<%=user._id%>/comment" method="POST" id="commentForm-<%= post._id %>" class="d-none mt-2">
              <div class="form-group">
                <textarea name="text" class="form-control" rows="2" placeholder="Write your comment here..." required></textarea>
              </div>
              <button type="submit" class="btn btn-sm btn-success mt-2">Post Comment</button>
            </form>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<script>
  function toggleEditForm(commentId) {
    const form = document.getElementById(`edit-form-${commentId}`);
    form.classList.toggle('d-none');
  }
</script>